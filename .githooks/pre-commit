#!/bin/sh
# Pre-commit hook: runs cs-check and tests before allowing commit
# Install: git config core.hooksPath .githooks

echo "ğŸ” Running pre-commit checks..."

# Check if Docker is running
if docker-compose ps 2>/dev/null | grep -q "Up"; then
    echo "ğŸ“¦ Using Docker container..."
    
    # Run CS check
    echo "ğŸ¨ Checking code style..."
    docker-compose exec -T php composer cs-check
    if [ $? -ne 0 ]; then
        echo "âŒ Code style check failed. Run 'make cs-fix' to fix issues."
        exit 1
    fi
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    docker-compose exec -T php composer test
    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed."
        exit 1
    fi
else
    # Try without Docker
    if command -v composer >/dev/null 2>&1; then
        echo "ğŸ’» Using local Composer..."
        
        # Run CS check
        echo "ğŸ¨ Checking code style..."
        composer cs-check
        if [ $? -ne 0 ]; then
            echo "âŒ Code style check failed. Run 'composer cs-fix' to fix issues."
            exit 1
        fi
        
        # Run tests
        echo "ğŸ§ª Running tests..."
        composer test
        if [ $? -ne 0 ]; then
            echo "âŒ Tests failed."
            exit 1
        fi
    else
        echo "âš ï¸  Skipping local checks (Docker not running, Composer not found)"
        echo "   Checks will run on GitHub Actions after push."
    fi
fi

echo "âœ… All checks passed!"
exit 0

